/*
 * This file was generated by the Gradle 'init' task.
 */

plugins {
    id 'java'

    id 'maven-publish'
    id 'com.github.johnrengelman.shadow' version '7.1.0'
    id "io.freefair.lombok" version "6.3.0"
//    kotlin("jvm") version '1.3.61'
    id 'org.jetbrains.kotlin.jvm' version '1.6.0'
//    id "org.jetbrains.kotlin.kapt" version "1.3.72"
}
apply plugin: 'idea'


repositories {
    mavenLocal()
    maven { url = "https://repo.aikar.co/content/groups/aikar/" }
    maven {
        url = 'https://oss.sonatype.org/content/repositories/snapshots'
    }

    maven {
        url = 'https://hub.spigotmc.org/nexus/content/repositories/snapshots/'
    }

    maven {
        url = 'https://repo.md-5.net/content/repositories/snapshots/'
    }

    maven {
        url = 'https://repo.extendedclip.com/content/repositories/placeholderapi/'
    }

    maven {
        url = 'https://nexus.hc.to/content/repositories/pub_releases'
    }

    maven { url 'https://jitpack.io' }

    maven {
        url = 'https://repo.maven.apache.org/maven2'
    }

    maven {
        url = "https://repo.md-5.net/content/repositories/releases/"
    }
    maven {
        name = "ess-repo"
        url = "https://ci.ender.zone/plugin/repository/everything/"
    }

    maven {
        name 'velocity'
        url 'https://nexus.velocitypowered.com/repository/maven-public/'
    }

    flatDir {
        dirs 'Dependencies'
    }
    mavenCentral()

    maven { url = "https://maven.enginehub.org/repo/" }

}

idea {
    module {
        downloadJavadoc = true
        downloadSources = true
    }
}

configurations {
    system
    compileOnly.extendsFrom system
}

dependencies {
    implementation ('com.github.Fernthedev.FernAPI:all:8a10ea6060') { //1.9.0-rc4'
        exclude group: "fr.minuskube.inv"
    }
    implementation ('com.github.Fernthedev.FernAPI:core') { //1.9.0-rc4'
        version {
            strictly '8a10ea6060'
        }
    }
//
//    constraints {
//        implementation ('com.github.Fernthedev.FernAPI:core') { //1.9.0-rc4'
//            version {
//                strictly 'v1.9.0rc4-mysql-annotations-e0342ba'
//            }
//            force = true
//        }
//    }
//    compileOnly 'com.google.apis:google-api-services-youtube:v3-rev193-1.23.0'
//    implementation 'com.google.oauth-client:google-oauth-client-jetty:1.23.0'
//    implementation 'com.google.api-client:google-api-client:1.23.0'

    // TODO: Publish this
    compileOnly 'com.github.Fernthedev.preferences_api:api:0.2.0'
    implementation 'com.github.Fernthedev:FernUtils:1.3.3'
    implementation 'org.mariadb.jdbc:mariadb-java-client:2.7.3'
    compileOnly 'net.md-5:bungeecord-api:1.18-R0.1-SNAPSHOT'
    compileOnly 'org.spigotmc:spigot-api:1.18-R0.1-SNAPSHOT'
    compileOnly 'me.clip:placeholderapi:2.9.2'
    compileOnly 'net.milkbowl.vault:VaultAPI:1.7'
    compileOnly 'com.sk89q.worldguard:worldguard-bukkit:7.0.4-SNAPSHOT'
    implementation 'com.velocitypowered:velocity-api:3.0.0'
    annotationProcessor 'com.velocitypowered:velocity-api:3.0.0'
//    compileOnly name: 'EssentialsX', group: 'net.ess3', version: '2.17.2'
    system name: 'AdvancedBan-2.2.1-RELEASE'
//    implementation 'me.leoko.advancedban:AdvancedBan:2.1.6'
    compileOnly 'com.github.sgtcaze:NametagEdit:8bbd20628b'
    compileOnly 'fr.neatmonster:nocheatplus:3.16.1-SNAPSHOT'
    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk8"
//    kapt "org.projectlombok:lombok:1.18.12"
}

group = 'com.github.Fernthedev'
version = '1.2'
archivesBaseName = "FCommands"
sourceCompatibility = targetCompatibility = JavaVersion.VERSION_17 // Need this here so eclipse task generates correctly.
compileJava {
    sourceCompatibility = targetCompatibility = JavaVersion.VERSION_17
}
compileJava.options.encoding = 'UTF-8'

jar.classifier("old")
shadowJar {
    classifier = ''
    minimize {
        exclude (dependency('org.mariadb.jdbc:.*:.*') )

        exclude (dependency('org.mariadb.*:') )
    }
    mergeServiceFiles()

//    include('org.mariadb.jdbc')

//    dependencies {
//
//    }

    var depGroupId = "${project.group}.dep"

    relocate 'co.aikar.commands', "${project.group}.preferences.acf"
    relocate 'co.aikar.locales', "${project.group}.preferences.locales"

    relocate 'com.zaxxer', "${depGroupId}.com.zaxxer"
    relocate 'co.aikar', "${depGroupId}.aikar"
    relocate 'org.jetbrains', "${depGroupId}.org.jetbrains"
    relocate 'org.mariadb', "${depGroupId}.org.mariadb"
    relocate 'javax', "${depGroupId}.javax"
//        relocate 'com.google.inject', "com.google.inject"
    relocate 'com.google', "${depGroupId}.com.google"
    relocate 'kotlin', "${depGroupId}.kotlin"
    relocate 'fr', "${depGroupId}.fr"


    relocate 'com.github.fernthedev.fernapi', "${project.group}.fernapi"
    relocate 'com.github.fernthedev.fernutils', "${project.group}.fernutils"
    relocate 'com.github.fernthedev.config', "${project.group}.config"
}

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
}


//task alljavadoc(type: Javadoc) {
//    source subprojects.collect { it.sourceSets.main.allJava }
//    classpath = files(subprojects.collect { it.sourceSets.main.compileClasspath })
//    destinationDir = file("${buildDir}/docs/javadoc")
//}

task sourcesJar(type: Jar, dependsOn: classes) {
    from sourceSets.main.java
}
task javadocJar(type: Jar, dependsOn: javadoc) {
    from javadoc.destinationDir
}

artifacts {
    archives javadocJar
    archives sourcesJar
}

publishing {
    publications {
        mavenJava(MavenPublication) {
            from components.java

            groupId = this.group;
            artifactId = this.archivesBaseName
            version = this.version

            artifact sourcesJar {
                classifier "sources"
            }

            artifact javadocJar {
                classifier "javadoc"
            }
        }
    }
}

java {
//        withJavadocJar()
    withSourcesJar()
}

javadoc {
    failOnError = false
}

jar.dependsOn(shadowJar)

shadowJar.finalizedBy javadocJar
shadowJar.finalizedBy sourcesJar

build.dependsOn sourcesJar

processResources {
    dependsOn(compileJava)
    inputs.property "version", project.version

    def velPath = compileJava.destinationDirectory.getAsFile().get()

    from(velPath) {
        include 'velocity-plugin.json'

        expand 'version':project.version
    }

    from(sourceSets.main.resources.srcDirs) {
        duplicatesStrategy = DuplicatesStrategy.WARN
        include 'plugin.yml'
        include 'bungee.yml'


        expand 'version':project.version
    }

}

task deleteVel(type: Delete) {
    dependsOn(compileJava)
    def velPath = compileJava.destinationDirectory.getAsFile().get()

    delete file("${velPath.path}/velocity-plugin.json")
}

jar.dependsOn deleteVel

compileJava {
    options.compilerArgs += ["-parameters"]
    options.fork = true
    options.forkOptions.executable = 'javac'
}
compileKotlin {
    kotlinOptions.javaParameters = true
    kotlinOptions {
        jvmTarget = JavaVersion.VERSION_17
    }
}
compileTestKotlin {
    kotlinOptions {
        jvmTarget = JavaVersion.VERSION_17
    }
}